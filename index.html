<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>æç«œè²©å£²ã‚³ãƒ”ãƒ¼ç”Ÿæˆ</title>

<style>
  :root{
    --bg:#0b0f14;
    --card:#141a22;
    --stroke:rgba(255,255,255,.10);
    --txt:rgba(255,255,255,.92);
    --mut:rgba(255,255,255,.60);
    --male:#74d7ff;
    --female:#ff86c8;
    --ok:#78ffb3;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
    background:var(--bg);
    color:var(--txt);
    padding-bottom:120px;
  }

  /* Top (sticky) */
  .top{
    position:sticky;
    top:0;
    z-index:20;
    padding:10px;
    padding-top:calc(10px + env(safe-area-inset-top));
    background:rgba(11,15,20,.95);
    backdrop-filter:blur(14px);
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .row{
    display:flex;
    gap:8px;
    align-items:center;
  }

  .search{
    flex:1;
    display:flex;
    align-items:center;
    gap:8px;
    height:36px;
    padding:0 10px;
    border-radius:14px;
    background:rgba(255,255,255,.07);
    border:1px solid rgba(255,255,255,.12);
    min-width:0;
  }
  .search input{
    width:100%;
    border:0;
    outline:none;
    background:transparent;
    color:var(--txt);
    font-size:14px;
  }
  .qClear{
    width:26px;
    height:26px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
    color:rgba(255,255,255,.90);
    font-size:18px;
    line-height:24px;
    padding:0;
    //display:none; /* å…¥åŠ›æ™‚ã®ã¿ */
    display:inline-block;

  }
  .qClear:active{transform:scale(.98);}

  .total{
    font-size:12px;
    color:var(--mut);
    white-space:nowrap;
  }
  .total b{
    color:var(--ok);
    font-size:14px;
  }

  .copy{
    height:36px;
    padding:0 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.08);
    color:var(--txt);
    font-weight:900;
    font-size:14px;
    white-space:nowrap;
  }
  .copy:active{transform:scale(.99);}

  textarea{
    width:100%;
    margin-top:8px;
    height:112px;
    resize:none;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.22);
    color:var(--txt);
    padding:10px 12px;
    font-size:12px;
    line-height:1.45;
    outline:none;
  }

  .list{padding:12px;}

  /* Cards */
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.10);
    border-radius:16px;
    padding:12px;
    margin-bottom:10px;
  }
  .head{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
  }
  .name{
    font-weight:900;
    font-size:15px;
  }
  .right{
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:4px;
  }
  .badge{
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    white-space:nowrap;
  }
  .unit{
    font-size:12px;
    color:var(--mut);
  }

  .controls{
    margin-top:10px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  select{
    width:100%;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:var(--txt);
    font-size:15px;
    outline:none;
  }

  .sexrow{display:flex; gap:10px;}
  .sex{
    flex:1;
    padding:10px;
    border-radius:16px;
    border:2px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.06);
  }
  .sex.m{border-color:rgba(116,215,255,.45); background:rgba(116,215,255,.16);}
  .sex.f{border-color:rgba(255,134,200,.45); background:rgba(255,134,200,.16);}
  .sexhead{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:8px;
    font-weight:900;
  }
  .sexhead .label.m{color:var(--male)}
  .sexhead .label.f{color:var(--female)}
  .count{
    font-variant-numeric:tabular-nums;
    font-size:20px;
  }
  .btns{display:flex; gap:10px;}
  .btn{
    flex:1;
    height:42px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.08);
    color:var(--txt);
    font-size:22px;
    font-weight:900;
    touch-action:manipulation;
  }
  .disabled{opacity:.35; pointer-events:none;}
</style>
</head>

<body>

<div class="top">
  <div class="row">
    <div class="search">
      <input id="q" placeholder="æ¤œç´¢ï¼ˆã²ã‚‰ãŒãªOKï¼‰" autocomplete="off">
      <button id="qClear" class="qClear" type="button" aria-label="æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢">Ã—</button>
    </div>
    <div class="total">åˆè¨ˆ <b id="total">0å††

<select id="delivery" style="
  height:36px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.08);
  color:#fff;
  font-size:13px;
  padding:0 10px;
">
  <option value="å³ç´å“å¯èƒ½">å³ç´å“å¯èƒ½</option>
  <option value="æœ¬æ—¥å¤œ">æœ¬æ—¥å¤œ</option>
</select>

</b></div>
    <button id="copy" class="copy" type="button">ã‚³ãƒ”ãƒ¼</button>
  </div>
  <textarea id="out" readonly placeholder="æ•°é‡ã‚’å…¥ã‚Œã‚‹ã¨è‡ªå‹•ã§æ›´æ–°ã•ã‚Œã¾ã™"></textarea>
</div>

<div class="list" id="list"></div>

<script>
  // å˜ä¾¡
  const prices = {
    "å—ç²¾åµ":30,
    "å—ç²¾åµ(æŒ‡å®š)":50,
    "å¹¼ä½“":100,
    "èƒš":50,
    "èƒš(æŒ‡å®š)":100,
    "æˆä½“":500
  };

  // â™‚â™€å†…è¨³ï¼ˆ&ãƒšã‚¢åˆ¤å®šï¼‰å¯¾è±¡
  // æŒ‡å®šãªã—ã®ã€Œå—ç²¾åµã€ã€Œèƒšã€ã¯å¯¾è±¡å¤–ï¼ˆãƒšã‚¢ã«ã‚‚ãªã‚‰ãªã„ï¼‰
  const sexTypes  = new Set(["å—ç²¾åµ(æŒ‡å®š)","èƒš(æŒ‡å®š)","å¹¼ä½“","æˆä½“"]);
  const pairTypes = new Set(["å—ç²¾åµ(æŒ‡å®š)","èƒš(æŒ‡å®š)","å¹¼ä½“","æˆä½“"]);

  const dinos = [];
  const state = new Map(); // name -> {type,m,f}
  const ui = new Map();    // name -> dom refs

  const listEl  = document.getElementById("list");
  const outEl   = document.getElementById("out");
  const totalEl = document.getElementById("total");
const deliveryEl = document.getElementById("delivery");
deliveryEl.addEventListener("change", rebuildOutput);
  const qEl     = document.getElementById("q");
  const qClearEl= document.getElementById("qClear");
  const copyBtn = document.getElementById("copy");

  function yen(n){ return Number(n).toLocaleString("ja-JP") + "å††"; }

  // ã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãª
  function kataToHira(str){
    return str.replace(/[\u30A1-\u30F6]/g, ch =>
      String.fromCharCode(ch.charCodeAt(0) - 0x60)
    );
  }

  // æ¤œç´¢ç”¨æ­£è¦åŒ–ï¼šã²ã‚‰ãŒãªåŒ–ï¼‹ç©ºç™½/è¨˜å·é™¤å»ï¼ˆæ—¥æœ¬èªã¯æ¶ˆã•ãªã„ï¼‰
  function normalize(str){
    const s = kataToHira(String(str || "").toLowerCase());
    return s.replace(/[\sã€€ãƒ»()ï¼ˆï¼‰ã€ã€‘\[\]ã€Œã€ã€ã€"'.\-_,/\\]/g,"");
  }

  // è¡¨ç¤ºä¸Šã¯(æŒ‡å®š)ã‚’æ¶ˆã™ï¼ˆå˜ä¾¡è¨ˆç®—ã¯å…ƒã®typeã§OKï¼‰
  function displayType(t){
    return String(t).replace("(æŒ‡å®š)", "");
  }

  // è¡Œï¼ˆç”Ÿç‰©åã®å¾Œã‚¹ãƒšãƒ¼ã‚¹ãªã—ã€=ä¸¡ç«¯ã ã‘åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã€é‡‘é¡ã¯3æ¡åŒºåˆ‡ã‚Šï¼‰
  // sexTypes/pairTypes ã¯ "æŒ‡å®šï¼‹å¹¼ä½“ï¼‹æˆä½“" ã®ã¿
  function formatLine(name, s){
    const qty = s.m + s.f;
    const unit = prices[s.type] || 0;
    const price = unit * qty;
    const t = displayType(s.type);

    if (pairTypes.has(s.type)){
      // åŒæ•°ãªã‚‰ãƒšã‚¢ï¼ˆÃ—Nï¼‰
      if (s.m === s.f && s.m > 0){
        const p = s.m;
        return `${name}${t}ãƒšã‚¢${p > 1 ? "Ã—" + p : ""} = ${price.toLocaleString("ja-JP")}å††`;
      }

      // åŒæ•°ã˜ã‚ƒãªã„ï¼š0ã¯è¡¨ç¤ºã—ãªã„ï¼ˆâ™‚1â™€0 ãªã‚‰ â™€Ã—0ã¯å‡ºã•ãªã„ï¼‰
      const parts = [];
      if (s.m > 0) parts.push(`â™‚Ã—${s.m}`);
      if (s.f > 0) parts.push(`â™€Ã—${s.f}`);

      return `${name}${t} ${parts.join(" ")} = ${price.toLocaleString("ja-JP")}å††`;
    }

    // ãã‚Œä»¥å¤–ï¼ˆæŒ‡å®šãªã—å—ç²¾åµ/èƒšã‚’å«ã‚€ï¼‰ã¯åˆç®—ã®ã¿ã€ãƒšã‚¢ã«ã—ãªã„
    return `${name}${t}Ã—${qty} = ${price.toLocaleString("ja-JP")}å††`;
  }

  function rebuildOutput(){
    let lines = [];
    let sum = 0;
    let idx = 1;

    for (const name of dinos){
      const s = state.get(name);
      if (!s) continue;

      const qty = s.m + s.f;
      if (qty === 0) continue;

      sum += (prices[s.type] || 0) * qty;
      lines.push(`${idx}. ${formatLine(name, s)}`);
      idx++;
    }

    totalEl.textContent = yen(sum);

    outEl.value =
`ã“ã®åº¦ã¯ã”æ¤œè¨ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
ã”å¸Œæœ›å†…å®¹ã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ğŸ‘‡ğŸ»

${lines.join("\n")}
ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼
è¨ˆï¼š${sum.toLocaleString("ja-JP")}å††
æœ€çŸ­ç´å“ç›®å®‰ : ${deliveryEl.value}

ã”å¸Œæœ›å†…å®¹ã€é‡‘é¡ã‚’ã”ç¢ºèªã®ä¸Šè³¼å…¥ã®æ–¹ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ğŸ™ğŸ»

ã¾ãŸã€è¿½åŠ ã‚„å¤‰æ›´ãªã©ã‚ã‚Šã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠç”³ã—ä»˜ã‘ãã ã•ã„ğŸ‘ğŸ»`;
  }

  function applySearch(){
    const raw = qEl.value || "";
    const q = normalize(raw);

    // Ã—ã¯ã€Œå…¥åŠ›ãŒã‚ã‚‹ã‹ã€ã§å‡ºã™ï¼ˆæ­£è¦åŒ–ã«ä¾å­˜ã—ãªã„ï¼‰
    qClearEl.style.display = raw.length ? "" : "none";

    for (const name of dinos){
      const ref = ui.get(name);
      if (!ref) continue;
      const hit = !q || ref.norm.includes(q);
      ref.card.style.display = hit ? "" : "none";
    }
  }

  function setModeForCard(name){
    const s = state.get(name);
    const ref = ui.get(name);
    if (!s || !ref) return;

    ref.badge.textContent = displayType(s.type);
    ref.unit.textContent = `å˜ä¾¡ ${yen(prices[s.type] || 0)}`;

    // sexTypesä»¥å¤–ã¯â™€ã‚’ç„¡åŠ¹åŒ–ã—ã¦0ã¸å¯„ã›ã‚‹ï¼ˆåˆç®—è¡¨ç¤ºç”¨ï¼‰
    if (!sexTypes.has(s.type)){
      s.f = 0;
      ref.fcnt.textContent = "0";
      ref.fBox.classList.add("disabled");
    } else {
      ref.fBox.classList.remove("disabled");
    }
  }

  function render(){
    listEl.innerHTML = "";
    ui.clear();

    for (const name of dinos){
      const s = state.get(name);

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="head">
          <div class="name">${name}</div>
          <div class="right">
            <div class="badge"></div>
            <div class="unit"></div>
          </div>
        </div>

        <div class="controls">
          <select class="type">
            <option ${s.type==="å—ç²¾åµ"?"selected":""}>å—ç²¾åµ</option>
            <option ${s.type==="å—ç²¾åµ(æŒ‡å®š)"?"selected":""}>å—ç²¾åµ(æŒ‡å®š)</option>
            <option ${s.type==="å¹¼ä½“"?"selected":""}>å¹¼ä½“</option>
            <option ${s.type==="èƒš"?"selected":""}>èƒš</option>
            <option ${s.type==="èƒš(æŒ‡å®š)"?"selected":""}>èƒš(æŒ‡å®š)</option>
            <option ${s.type==="æˆä½“"?"selected":""}>æˆä½“</option>
          </select>

          <div class="sexrow">
            <div class="sex m">
              <div class="sexhead">
                <div class="label m">â™‚</div>
                <div class="count mcnt">0</div>
              </div>
              <div class="btns">
                <button class="btn" type="button" data-sex="m" data-d="-1">âˆ’</button>
                <button class="btn" type="button" data-sex="m" data-d="1">ï¼‹</button>
              </div>
            </div>

            <div class="sex f">
              <div class="sexhead">
                <div class="label f">â™€</div>
                <div class="count fcnt">0</div>
              </div>
              <div class="btns">
                <button class="btn" type="button" data-sex="f" data-d="-1">âˆ’</button>
                <button class="btn" type="button" data-sex="f" data-d="1">ï¼‹</button>
              </div>
            </div>
          </div>
        </div>
      `;
      listEl.appendChild(card);

      const badge = card.querySelector(".badge");
      const unit  = card.querySelector(".unit");
      const sel   = card.querySelector(".type");
      const mcnt  = card.querySelector(".mcnt");
      const fcnt  = card.querySelector(".fcnt");
      const fBox  = card.querySelector(".sex.f");

      const ref = {
        card,
        badge,
        unit,
        sel,
        mcnt,
        fcnt,
        fBox,
        norm: normalize(name)
      };
      ui.set(name, ref);

      // åˆæœŸè¡¨ç¤º
      mcnt.textContent = String(s.m);
      fcnt.textContent = String(s.f);

      // ã‚¿ã‚¤ãƒ—å¤‰æ›´
      sel.addEventListener("change", () => {
        s.type = sel.value;
        setModeForCard(name);
        rebuildOutput();
      });

      // Â±ãƒœã‚¿ãƒ³
      card.querySelectorAll("button[data-sex]").forEach(btn => {
        btn.addEventListener("click", () => {
          const sex = btn.dataset.sex;
          const d = Number(btn.dataset.d);

          // æ€§åˆ¥ä¸è¦ã‚¿ã‚¤ãƒ—ã§â™€ã¯è§¦ã‚‰ã›ãªã„
          if (!sexTypes.has(s.type) && sex === "f") return;

          s[sex] = Math.max(0, s[sex] + d);
          if (sex === "m") mcnt.textContent = String(s.m);
          else fcnt.textContent = String(s.f);

          setModeForCard(name);
          rebuildOutput();
        });
      });

      setModeForCard(name);
    }

    applySearch();
    rebuildOutput();
  }

  // ã‚³ãƒ”ãƒ¼æ¼”å‡º
  let copyTimer = null;
  async function copyOut(){
    const text = outEl.value.trim();
    if (!text){
      alert("ã¾ã å‡ºåŠ›ãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }
    try{
      await navigator.clipboard.writeText(text);
    }catch(e){
      outEl.focus(); outEl.select();
      document.execCommand("copy");
    }

    const prev = copyBtn.textContent;
    copyBtn.textContent = "ã‚³ãƒ”ãƒ¼æ¸ˆã¿ âœ“";
    copyBtn.disabled = true;
    if (copyTimer) clearTimeout(copyTimer);
    copyTimer = setTimeout(() => {
      copyBtn.textContent = prev;
      copyBtn.disabled = false;
    }, 1200);
  }

  // æ¤œç´¢å…¥åŠ›/ã‚¯ãƒªã‚¢ï¼ˆÃ—ã§ç¢ºå®Ÿã«ãƒªã‚»ãƒƒãƒˆï¼‰
  qEl.addEventListener("input", applySearch);
  qClearEl.addEventListener("click", () => {
    qEl.value = "";
    applySearch();
    qEl.focus();
  });

  copyBtn.addEventListener("click", copyOut);

  async function load(){
    const res = await fetch(`dinos.txt?ts=${Date.now()}`);
    const text = await res.text();
    const lines = text.split(/\r?\n/).map(s => s.trim().replace(/^ãƒ»\s*/,"")).filter(Boolean);

    dinos.length = 0;
    state.clear();

    for (const d of lines){
      dinos.push(d);
      state.set(d, {type:"å—ç²¾åµ", m:0, f:0});
    }

    render();
  }

  load();
</script>

</body>
</html>
