<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport"
  content="width=device-width,
           initial-scale=1,
           maximum-scale=1,
           user-scalable=no,
           viewport-fit=cover">

<title>æç«œè²©å£²ã‚³ãƒ”ãƒ¼ç”Ÿæˆ</title>

<style>
:root{
  --bg:#0b0f14;
  --txt:rgba(255,255,255,.92);
  --mut:rgba(255,255,255,.60);
  --male:#74d7ff;
  --female:#ff86c8;
  --ok:#78ffb3;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
  background:var(--bg);
  color:var(--txt);
  padding-bottom:120px;
}
button,select,input{touch-action:manipulation}

/* ===== top ===== */
.top{
  position:sticky;
  top:0;
  z-index:10;
  background:rgba(11,15,20,.95);
  backdrop-filter:blur(14px);
  padding:10px;
  padding-top:calc(10px + env(safe-area-inset-top));
  border-bottom:1px solid rgba(255,255,255,.06);
}
.row{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}
.search{
  flex:1;
  display:flex;
  align-items:center;
  gap:8px;
  height:36px;
  padding:0 10px;
  border-radius:14px;
  background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.12);
  min-width:0;
}
.search input{
  flex:1;
  border:0;
  outline:none;
  background:transparent;
  color:var(--txt);
  font-size:14px;
  min-width:0;
}
.qClear{
  width:26px;height:26px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  font-size:18px;
  color:#fff;
  display:inline-block; /* â† æŒ‡å®šã©ãŠã‚Šå›ºå®š */
  line-height:1;
}
.delivery,.copy{
  height:36px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.08);
  color:#fff;
  padding:0 12px;
}
.copy{font-weight:900}
.total{
  margin-left:auto;
  font-size:14px;
  color:var(--ok);
  font-weight:900;
  white-space:nowrap;
}
textarea{
  width:100%;
  margin-top:8px;
  height:120px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  color:#fff;
  padding:10px;
  font-size:12px;
  line-height:1.45;
}

/* ===== list ===== */
.list{padding:12px}
.card{
  display:block;
  background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.10);
  border-radius:16px;
  padding:12px;
  margin-bottom:10px;
}
.card.hidden{display:none !important}

/* 0ã®ã¨ãã¯ä¸­èº«ã ã‘ç•³ã‚€ï¼ˆãƒ˜ãƒƒãƒ€ã¯æ®‹ã™ï¼‰ */
.card.autoCollapsed .sexrow{display:none}
.card.autoCollapsed{padding-bottom:10px}

.head{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
}
.name{
  font-weight:900;
  line-height:1.2;
  padding-top:2px;
}
.right{
  text-align:right;
  display:flex;
  flex-direction:column;
  gap:4px;
  min-width:112px;
}
select.type{
  padding:6px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.14);
  color:#fff;
  font-size:12px;
}
.unit{font-size:12px;color:var(--mut)}

/* ===== compact steppers ===== */
.sexrow{
  display:flex;
  gap:10px;
  margin-top:10px;
}
.sex{
  flex:1;
  padding:8px;
  border-radius:14px;
  border:2px solid rgba(255,255,255,.10);
}
.sex.m{
  border-color:rgba(116,215,255,.45);
  background:rgba(116,215,255,.14);
}
.sex.f{
  border-color:rgba(255,134,200,.45);
  background:rgba(255,134,200,.14);
}
/* â™€ç„¡åŠ¹æ™‚ï¼šè¦‹ãŸç›®ã‚‚ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ */
.sex.f.disabled{
  border-color:rgba(255,255,255,.16);
  background:rgba(255,255,255,.04);
  filter:saturate(0);
  opacity:.55;
}
.sex.f.disabled *{pointer-events:none}

.stepper{
  display:flex;
  align-items:center;
  gap:8px;
}
.btn{
  width:44px;
  height:30px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.10);
  color:#fff;
  font-size:18px;
  font-weight:900;
  line-height:1;
  padding:0;
}
.val{
  flex:1;
  text-align:center;
  font-weight:900;
  font-size:16px;
  letter-spacing:.2px;
  color:rgba(255,255,255,.92);
}
</style>
</head>

<body>

<div class="top">
  <div class="row">
    <div class="search">
      <input id="q" placeholder="æ¤œç´¢">
      <button id="qClear" class="qClear" type="button">Ã—</button>
    </div>

    <select id="delivery" class="delivery">
      <option value="å³ç´å“å¯èƒ½">å³ç´å“å¯èƒ½</option>
      <option value="æœ¬æ—¥å¤œ">æœ¬æ—¥å¤œ</option>
    </select>

    <button id="copy" class="copy" type="button">ã‚³ãƒ”ãƒ¼</button>
    <div id="total" class="total">0å††</div>
  </div>

  <textarea id="out" readonly></textarea>
</div>

<div class="list" id="list"></div>

<script>
/* ===== data ===== */
const prices={
  "å—ç²¾åµ":30,"å—ç²¾åµ(æŒ‡å®š)":50,
  "å¹¼ä½“":100,"èƒš":50,"èƒš(æŒ‡å®š)":100,"æˆä½“":500,
  "ã‚¯ãƒ­ãƒ¼ãƒ³":500,"ã‚¯ãƒ­ãƒ¼ãƒ³(æŒ‡å®š)":300
};

// â™‚â™€åŒºåˆ¥ã™ã‚‹ã‚¿ã‚¤ãƒ—ï¼ˆæˆä½“ç›¸å½“ + ã‚¯ãƒ­ãƒ¼ãƒ³å«ã‚€ï¼‰
const sexTypes=new Set([
  "å—ç²¾åµ(æŒ‡å®š)","èƒš(æŒ‡å®š)","å¹¼ä½“","æˆä½“",
  "ã‚¯ãƒ­ãƒ¼ãƒ³","ã‚¯ãƒ­ãƒ¼ãƒ³(æŒ‡å®š)"
]);

// ãƒšã‚¢è¡¨è¨˜ã®å¯¾è±¡ï¼ˆä¸Šã¨åŒã˜ï¼‰
const pairTypes=new Set([
  "å—ç²¾åµ(æŒ‡å®š)","èƒš(æŒ‡å®š)","å¹¼ä½“","æˆä½“",
  "ã‚¯ãƒ­ãƒ¼ãƒ³","ã‚¯ãƒ­ãƒ¼ãƒ³(æŒ‡å®š)"
]);

const dinos=[], state=new Map();
const listEl=document.getElementById("list");
const outEl=document.getElementById("out");
const totalEl=document.getElementById("total");
const qEl=document.getElementById("q");
const qClear=document.getElementById("qClear");
const delivery=document.getElementById("delivery");
const copyBtn=document.getElementById("copy");

function yen(n){return n.toLocaleString("ja-JP")+"å††"}

/* ã²ã‚‰ãŒãªæ¤œç´¢ */
function toHira(str){
  return (str||"").replace(/[\u30a1-\u30f6]/g, ch =>
    String.fromCharCode(ch.charCodeAt(0) - 0x60)
  );
}
function norm(str){
  return toHira((str||"").trim()).toLowerCase();
}

/* dinos.txt 1è¡Œã®ãƒ‘ãƒ¼ã‚¹: æç«œå|ã‚¿ã‚¤ãƒ— */
function parseLine(line){
  line = (line||"").trim();
  if(!line) return null;
  if(line.startsWith("#")) return null;

  line = line.replace(/^ãƒ»/,"").trim();
  if(!line) return null;

  const [rawName, rawType] = line.split("|");
  const name = (rawName||"").trim();
  const t = (rawType||"").trim();
  if(!name) return null;

  const defType = (t && (t in prices)) ? t : "å—ç²¾åµ";
  return {name, defType};
}

/* ===== UI helpers ===== */
function applyFemaleDisabled(s){
  const card = s.card;
  const fbox = card.querySelector(".sex.f");
  const fc = card.querySelector(".fc");

  if(!sexTypes.has(s.type)){
    s.f = 0;
    fc.textContent = "0";
    fbox.classList.add("disabled");
  }else{
    fbox.classList.remove("disabled");
  }
}

function updateCardAutoCollapse(s){
  const qty = s.m + s.f;
  // å…¥åŠ›ãªã—ã¯è‡ªå‹•ã§ç•³ã‚€ï¼ˆãƒ˜ãƒƒãƒ€ã ã‘ï¼‰
  s.card.classList.toggle("autoCollapsed", qty === 0);
}

/* ===== rebuild ===== */
function rebuild(){
  let lines=[],sum=0,idx=1;

  for (const name of dinos){
    const s=state.get(name);
    const qty=s.m+s.f;
    updateCardAutoCollapse(s);

    if(qty===0) continue;

    const price=(prices[s.type]||0)*qty;
    sum+=price;

    const t=s.type.replace("(æŒ‡å®š)","");
    let line="";

    if(pairTypes.has(s.type)){
      if(s.m===s.f){
        line = `${name}${t}ãƒšã‚¢${s.m>1 ? "Ã—"+s.m : ""} = ${price.toLocaleString("ja-JP")}å††`;
      }else{
        const p=[];
        if(s.m>0) p.push(`â™‚Ã—${s.m}`);
        if(s.f>0) p.push(`â™€Ã—${s.f}`);
        // ç‰‡æ–¹0ã¯è¡¨ç¤ºã—ãªã„ï¼ˆpãŒç‰‡æ–¹ã ã‘ã«ãªã‚‹ï¼‰
        line = `${name}${t}${p.length ? " " + p.join(" ") : ""} = ${price.toLocaleString("ja-JP")}å††`;
      }
    }else{
      line = `${name}${t}Ã—${qty} = ${price.toLocaleString("ja-JP")}å††`;
    }

    lines.push(`${idx}. ${line}`);
    idx++;
  }

  totalEl.textContent = yen(sum);

  outEl.value =
`ã“ã®åº¦ã¯ã”æ¤œè¨ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
ã”å¸Œæœ›å†…å®¹ã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ğŸ‘‡ğŸ»

${lines.join("\n")}
ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼
è¨ˆï¼š${sum.toLocaleString("ja-JP")}å††
æœ€çŸ­ç´å“ç›®å®‰ : ${delivery.value}

ã”å¸Œæœ›å†…å®¹ã€é‡‘é¡ã‚’ã”ç¢ºèªã®ä¸Šè³¼å…¥ã®æ–¹ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ğŸ™ğŸ»

ã¾ãŸã€è¿½åŠ ã‚„å¤‰æ›´ãªã©ã‚ã‚Šã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠç”³ã—ä»˜ã‘ãã ã•ã„ğŸ‘ğŸ»`;
}

/* ===== searchï¼ˆå®Œå…¨ã«ä½œã‚Šç›´ã—ï¼‰ ===== */
function applySearch(){
  const q = norm(qEl.value);

  for (const name of dinos){
    const s = state.get(name);
    // cardã«æŒã£ã¦ã‚‹æ­£è¦åŒ–ã‚­ãƒ¼ï¼ˆã²ã‚‰ãŒãªåŒ–æ¸ˆã¿ï¼‰ã§æ¤œç´¢
    const hit = !q || s.key.includes(q);
    s.card.classList.toggle("hidden", !hit);

    // æ¤œç´¢ä¸­ã¯ãƒ’ãƒƒãƒˆã—ãŸã‚«ãƒ¼ãƒ‰ã ã‘ç•³ã¾ãªã„ï¼ˆå…¥åŠ›ã—ã‚„ã™ã„ï¼‰
    if(q && hit){
      s.card.classList.remove("autoCollapsed");
    }else{
      updateCardAutoCollapse(s);
    }
  }
}

// iOS IMEå–ã‚Šã“ã¼ã—å¯¾ç­–ï¼šå…¨éƒ¨ã¤ã‘ã‚‹
["input","change","keyup","compositionend"].forEach(ev=>{
  qEl.addEventListener(ev, ()=>requestAnimationFrame(applySearch));
});
qClear.addEventListener("click", ()=>{
  qEl.value="";
  applySearch();
});

/* copyï¼ˆæ¼”å‡ºã‚ã‚Šï¼‰ */
copyBtn.addEventListener("click", async ()=>{
  const t = outEl.value.trim();
  if(!t) return;

  try{
    await navigator.clipboard.writeText(t);
  }catch(e){
    outEl.focus();
    outEl.select();
    document.execCommand("copy");
  }
  const prev = copyBtn.textContent;
  copyBtn.textContent="ã‚³ãƒ”ãƒ¼æ¸ˆã¿âœ“";
  copyBtn.style.opacity="0.8";
  setTimeout(()=>{
    copyBtn.textContent=prev;
    copyBtn.style.opacity="";
  }, 1200);
});

/* ===== é‡è¦ï¼šã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼ˆstateã‚ºãƒ¬ã‚’æ ¹çµ¶ï¼‰ ===== */
listEl.addEventListener("click", (e)=>{
  const btn = e.target.closest(".btn");
  if(!btn) return;

  const card = e.target.closest(".card");
  if(!card) return;

  const name = card.dataset.name;
  const s = state.get(name);
  if(!s) return;

  const sex = btn.dataset.sex;   // "m" or "f"
  const d = Number(btn.dataset.d);

  if(sex==="f" && !sexTypes.has(s.type)) return;

  s[sex] = Math.max(0, s[sex] + d);

  // è¡¨ç¤ºæ›´æ–°
  card.querySelector(".mc").textContent = String(s.m);
  card.querySelector(".fc").textContent = String(s.f);

  rebuild();
});

listEl.addEventListener("change", (e)=>{
  const sel = e.target.closest("select.type");
  if(!sel) return;

  const card = e.target.closest(".card");
  if(!card) return;

  const name = card.dataset.name;
  const s = state.get(name);
  if(!s) return;

  s.type = sel.value;

  card.querySelector(".unit").textContent = `å˜ä¾¡${prices[s.type]}å††`;
  applyFemaleDisabled(s);

  // å€¤è¡¨ç¤ºï¼ˆâ™€ãŒ0ã«ã•ã‚ŒãŸå ´åˆã‚‚åæ˜ ï¼‰
  card.querySelector(".mc").textContent = String(s.m);
  card.querySelector(".fc").textContent = String(s.f);

  rebuild();
});

/* ===== load ===== */
async function load(){
  const text = await fetch("dinos.txt?ts="+Date.now(), {cache:"no-store"}).then(r=>r.text());

  text.split(/\r?\n/)
    .map(parseLine)
    .filter(Boolean)
    .forEach(({name, defType})=>{
      dinos.push(name);

      const s={type:defType,m:0,f:0};
      s.key = norm(name); // ã²ã‚‰ãŒãªåŒ–ã‚­ãƒ¼
      state.set(name,s);

      const card=document.createElement("div");
      card.className="card autoCollapsed";
      card.dataset.name = name;
      s.card = card;

      card.innerHTML=`
        <div class="head">
          <div class="name">${name}</div>
          <div class="right">
            <select class="type">
              ${Object.keys(prices).map(t=>`<option value="${t}">${t}</option>`).join("")}
            </select>
            <div class="unit">å˜ä¾¡30å††</div>
          </div>
        </div>

        <div class="sexrow">
          <div class="sex m">
            <div class="stepper">
              <button class="btn" data-sex="m" data-d="-1" type="button">âˆ’</button>
              <div class="val mc">0</div>
              <button class="btn" data-sex="m" data-d="1" type="button">ï¼‹</button>
            </div>
          </div>

          <div class="sex f">
            <div class="stepper">
              <button class="btn" data-sex="f" data-d="-1" type="button">âˆ’</button>
              <div class="val fc">0</div>
              <button class="btn" data-sex="f" data-d="1" type="button">ï¼‹</button>
            </div>
          </div>
        </div>
      `;

      listEl.appendChild(card);

      // åˆæœŸå€¤åæ˜ 
      const sel = card.querySelector("select.type");
      sel.value = defType;

      s.type = defType;
      card.querySelector(".unit").textContent = `å˜ä¾¡${prices[s.type]}å††`;

      applyFemaleDisabled(s);
      updateCardAutoCollapse(s);
    });

  rebuild();
  applySearch();
}
load();
</script>

</body>
</html>
