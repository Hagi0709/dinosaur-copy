<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width,
           initial-scale=1,
           maximum-scale=1,
           user-scalable=no,
           viewport-fit=cover"
/>

<title>æç«œãƒªã‚¹ãƒˆ</title>

<!-- iPhone ãƒ›ãƒ¼ãƒ ç”»é¢ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆåŒéšå±¤ã®ç”»åƒã‚’ä½¿ç”¨ï¼‰ -->
<link rel="apple-touch-icon" href="56379E4F-8771-431A-B2A6-4B3EE3136504.png" />

<style>
:root{
  --bg:#0b0f14;
  --txt:rgba(255,255,255,.92);
  --mut:rgba(255,255,255,.60);
  --stroke:rgba(255,255,255,.12);
  --ok:#78ffb3;

  --male:#74d7ff;
  --female:#ff86c8;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
  background:var(--bg);
  color:var(--txt);
  padding-bottom:140px;
}
button,select,input{touch-action:manipulation}
button{cursor:pointer}
input,select,button{outline:none}

/* ===== top ===== */
.top{
  position:sticky;
  top:0;
  z-index:20;
  background:rgba(11,15,20,.95);
  backdrop-filter:blur(14px);
  padding:10px;
  padding-top:calc(10px + env(safe-area-inset-top));
  border-bottom:1px solid rgba(255,255,255,.06);
}
.row{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}
.search{
  flex:1;
  display:flex;
  align-items:center;
  gap:8px;
  height:36px;
  padding:0 10px;
  border-radius:14px;
  background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.12);
  min-width:0;
}
.search input{
  flex:1;
  border:0;
  background:transparent;
  color:var(--txt);
  font-size:14px;
  min-width:0;
}
.qClear{
  width:26px;height:26px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  font-size:18px;
  color:#fff;
  display:inline-block; /* â† æ¬¡ã‹ã‚‰ã“ã‚Œ */
  line-height:24px;
}
.delivery,.copy,.addBtn,.manageBtn{
  height:36px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.08);
  color:#fff;
  padding:0 12px;
  font-size:13px;
}
.copy{
  font-weight:900;
}
.total{
  margin-left:auto;
  font-size:14px;
  color:var(--ok);
  font-weight:900;
  white-space:nowrap;
}

textarea{
  width:100%;
  margin-top:8px;
  height:120px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  color:#fff;
  padding:10px;
  font-size:12px;
  line-height:1.45;
}

/* tabs */
.tabs{
  display:flex;
  gap:10px;
  margin-top:10px;
}
.tab{
  flex:1;
  height:40px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:rgba(255,255,255,.86);
  font-weight:900;
  font-size:14px;
}
.tab.active{
  background:rgba(255,255,255,.14);
  border-color:rgba(255,255,255,.18);
  color:#fff;
}

/* ===== list ===== */
.list{padding:12px}
.section{
  display:none;
}
.section.active{display:block}

.card{
  background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.10);
  border-radius:16px;
  padding:12px;
  margin-bottom:10px;
  overflow:hidden;
}
.cardHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.name{
  font-weight:900;
  font-size:16px;
  letter-spacing:.2px;
}
.right{
  text-align:right;
  display:flex;
  flex-direction:column;
  gap:4px;
  align-items:flex-end;
}
select.type{
  padding:6px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.14);
  color:#fff;
  font-size:12px;
}
.unit{font-size:12px;color:var(--mut)}

/* collapsible body */
.cardBody{
  margin-top:10px;
}
.card.collapsed .cardBody{
  display:none;
}

/* ===== steppers ===== */
.stepRow{
  display:flex;
  gap:10px;
}
.box{
  flex:1;
  padding:8px;
  border-radius:14px;
  border:2px solid rgba(255,255,255,.10);
}
.box.m{
  border-color:rgba(116,215,255,.45);
  background:rgba(116,215,255,.14);
}
.box.f{
  border-color:rgba(255,134,200,.45);
  background:rgba(255,134,200,.14);
}

/* buttons (low height) */
.stepper{
  display:flex;
  align-items:center;
  gap:10px;
}
.btn{
  width:46px;
  height:32px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.10);
  color:#fff;
  font-size:18px;
  font-weight:900;
  line-height:1;
}
.val{
  flex:1;
  text-align:center;
  font-weight:900;
  font-size:16px;
  letter-spacing:.2px;
  color:rgba(255,255,255,.92);
}

/* item single stepper */
.box.item{
  border-color:rgba(255,255,255,.18);
  background:rgba(255,255,255,.06);
}

/* modal */
.modalBack{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter:blur(8px);
  display:none;
  z-index:50;
  padding:18px;
  padding-top:calc(18px + env(safe-area-inset-top));
}
.modalBack.show{display:block}
.modal{
  max-width:520px;
  margin:0 auto;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));
  padding:14px;
}
.modal h3{
  margin:0 0 10px 0;
  font-size:16px;
}
.form{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.field{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.field label{
  font-size:12px;
  color:rgba(255,255,255,.72);
}
.field input,.field select{
  height:40px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.22);
  color:#fff;
  padding:0 12px;
  font-size:14px;
}
.modalBtns{
  display:flex;
  gap:10px;
  margin-top:12px;
}
.modalBtns button{
  flex:1;
  height:42px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.08);
  color:#fff;
  font-weight:900;
}
.smallNote{
  font-size:12px;
  color:rgba(255,255,255,.60);
  line-height:1.4;
}
.danger{
  background:rgba(255,80,80,.10)!important;
  border-color:rgba(255,80,80,.25)!important;
}
</style>
</head>

<body>
  <div class="top">
    <div class="row">
      <div class="search">
        <input id="q" placeholder="æ¤œç´¢" />
        <button id="qClear" class="qClear" aria-label="clear">Ã—</button>
      </div>

      <select id="delivery" class="delivery">
        <option value="å³ç´å“å¯èƒ½">å³ç´å“å¯èƒ½</option>
        <option value="æœ¬æ—¥å¤œ">æœ¬æ—¥å¤œ</option>
      </select>

      <button id="copy" class="copy">ã‚³ãƒ”ãƒ¼</button>
      <div id="total" class="total">0å††</div>
    </div>

    <textarea id="out" readonly></textarea>

    <div class="row" style="margin-top:10px;">
      <button id="add" class="addBtn">ï¼‹è¿½åŠ </button>
      <button id="manage" class="manageBtn">ç®¡ç†</button>
    </div>

    <div class="tabs">
      <button id="tabDino" class="tab active">æç«œ</button>
      <button id="tabItem" class="tab">ã‚¢ã‚¤ãƒ†ãƒ </button>
    </div>
  </div>

  <div class="list">
    <div id="secDino" class="section active"></div>
    <div id="secItem" class="section"></div>
  </div>

  <!-- Modal -->
  <div id="modalBack" class="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <h3 id="modalTitle">è¿½åŠ </h3>

      <div id="modalBody"></div>

      <div class="modalBtns">
        <button id="modalCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="modalOk">è¿½åŠ </button>
      </div>

      <div id="modalNote" class="smallNote" style="margin-top:10px;"></div>
    </div>
  </div>

<script>
/* ======================
   Utilities
====================== */
function yen(n){ return Number(n||0).toLocaleString("ja-JP") + "å††"; }

// ã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãªï¼ˆæ¤œç´¢å®‰å®šåŒ–ï¼šã‹ã‚‹ ã§ ã‚«ãƒ«ã‚«ãƒ­ ãŒå‡ºã‚‹ï¼‰
function kataToHira(str){
  return (str||"").replace(/[\u30A1-\u30F6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
}
function norm(str){
  return kataToHira(String(str||""))
    .toLowerCase()
    .replace(/\s+/g,"")
    .trim();
}

/* ======================
   Pricing / Types
====================== */
const prices = {
  "å—ç²¾åµ":30, "å—ç²¾åµ(æŒ‡å®š)":50,
  "èƒš":50,   "èƒš(æŒ‡å®š)":100,
  "å¹¼ä½“":100,
  "æˆä½“":500,
  "ã‚¯ãƒ­ãƒ¼ãƒ³":500, "ã‚¯ãƒ­ãƒ¼ãƒ³(æŒ‡å®š)":300
};

const hasSpecified = {
  "å—ç²¾åµ":"å—ç²¾åµ(æŒ‡å®š)",
  "èƒš":"èƒš(æŒ‡å®š)",
  "ã‚¯ãƒ­ãƒ¼ãƒ³":"ã‚¯ãƒ­ãƒ¼ãƒ³(æŒ‡å®š)"
};
const baseFromSpecified = {
  "å—ç²¾åµ(æŒ‡å®š)":"å—ç²¾åµ",
  "èƒš(æŒ‡å®š)":"èƒš",
  "ã‚¯ãƒ­ãƒ¼ãƒ³(æŒ‡å®š)":"ã‚¯ãƒ­ãƒ¼ãƒ³"
};

// â™‚â™€åŒºåˆ¥ï¼ˆæç«œå´ï¼‰
const sexTypes = new Set([
  "å—ç²¾åµ","å—ç²¾åµ(æŒ‡å®š)",
  "èƒš","èƒš(æŒ‡å®š)",
  "å¹¼ä½“","æˆä½“",
  "ã‚¯ãƒ­ãƒ¼ãƒ³","ã‚¯ãƒ­ãƒ¼ãƒ³(æŒ‡å®š)"
]);

// ãƒšã‚¢è¡¨è¨˜ï¼ˆæç«œå´ï¼‰
const pairTypes = new Set([
  "å—ç²¾åµ","å—ç²¾åµ(æŒ‡å®š)",
  "èƒš","èƒš(æŒ‡å®š)",
  "å¹¼ä½“","æˆä½“",
  "ã‚¯ãƒ­ãƒ¼ãƒ³","ã‚¯ãƒ­ãƒ¼ãƒ³(æŒ‡å®š)"
]);

function displayType(t){
  return String(t||"").replace("(æŒ‡å®š)","");
}

/* ======================
   Storage (Aæ–¹å¼)
====================== */
const LS_KEY = "dinoList_v1_storage";

function loadStore(){
  try{
    const obj = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
    return {
      dinosAdded: Array.isArray(obj.dinosAdded) ? obj.dinosAdded : [],
      dinosDeleted: Array.isArray(obj.dinosDeleted) ? obj.dinosDeleted : [],
      itemsAdded: Array.isArray(obj.itemsAdded) ? obj.itemsAdded : [],
      itemsDeleted: Array.isArray(obj.itemsDeleted) ? obj.itemsDeleted : [],
      delivery: typeof obj.delivery === "string" ? obj.delivery : "å³ç´å“å¯èƒ½"
    };
  }catch{
    return { dinosAdded:[], dinosDeleted:[], itemsAdded:[], itemsDeleted:[], delivery:"å³ç´å“å¯èƒ½" };
  }
}
function saveStore(){
  const obj = {
    dinosAdded: store.dinosAdded,
    dinosDeleted: store.dinosDeleted,
    itemsAdded: store.itemsAdded,
    itemsDeleted: store.itemsDeleted,
    delivery: deliveryEl.value
  };
  localStorage.setItem(LS_KEY, JSON.stringify(obj));
}

const store = loadStore();

/* ======================
   DOM
====================== */
const qEl = document.getElementById("q");
const qClear = document.getElementById("qClear");
const deliveryEl = document.getElementById("delivery");
const copyBtn = document.getElementById("copy");
const totalEl = document.getElementById("total");
const outEl = document.getElementById("out");

const tabDino = document.getElementById("tabDino");
const tabItem = document.getElementById("tabItem");
const secDino = document.getElementById("secDino");
const secItem = document.getElementById("secItem");

const addBtn = document.getElementById("add");
const manageBtn = document.getElementById("manage");

const modalBack = document.getElementById("modalBack");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
const modalOk = document.getElementById("modalOk");
const modalCancel = document.getElementById("modalCancel");
const modalNote = document.getElementById("modalNote");

/* ======================
   Data Models
====================== */
// dino: {name, defType, type, m, f, card, open, normName, autoSpecified:boolean}
// item: {name, unitCount, unitPrice, qty, card, open, normName}

const dinos = [];
const items = [];
const dinoState = new Map();
const itemState = new Map();

let activeTab = "dino"; // "dino" | "item"

/* ======================
   Base file parsers
====================== */
function parseDinoLine(line){
  line = (line||"").trim();
  if(!line) return null;
  if(line.startsWith("#")) return null;

  line = line.replace(/^ãƒ»/,"").trim();
  if(!line) return null;

  const parts = line.split("|").map(s=>s.trim());
  const name = parts[0] || "";
  const rawType = parts[1] || "";
  if(!name) return null;

  const defType = (rawType && (rawType in prices)) ? rawType : "å—ç²¾åµ";
  return { name, defType };
}

function parseItemLine(line){
  line = (line||"").trim();
  if(!line) return null;
  if(line.startsWith("#")) return null;

  // å½¢å¼: å•†å“å | å€‹æ•°å˜ä½ | å€¤æ®µ
  const parts = line.split("|").map(s=>s.trim());
  if(parts.length < 3) return null;

  const name = parts[0];
  const unitCount = Number(parts[1]);
  const unitPrice = Number(parts[2]);

  if(!name) return null;
  if(!Number.isFinite(unitCount) || unitCount <= 0) return null;
  if(!Number.isFinite(unitPrice) || unitPrice < 0) return null;

  return { name, unitCount, unitPrice };
}

/* ======================
   UI: Tabs
====================== */
function setTab(next){
  activeTab = next;
  tabDino.classList.toggle("active", next==="dino");
  tabItem.classList.toggle("active", next==="item");
  secDino.classList.toggle("active", next==="dino");
  secItem.classList.toggle("active", next==="item");

  // æ¤œç´¢ã¯ãã®ã¾ã¾ã€‚è¡¨ç¤ºã ã‘æ›´æ–°
  applyFilter();
}
tabDino.onclick = ()=>setTab("dino");
tabItem.onclick = ()=>setTab("item");

/* ======================
   Search
====================== */
function applyFilter(){
  const q = norm(qEl.value);

  if(activeTab === "dino"){
    dinos.forEach(name=>{
      const s = dinoState.get(name);
      const hit = !q || s.normName.includes(q);
      s.card.style.display = hit ? "" : "none";

      // æ¤œç´¢ä¸­ï¼šãƒ’ãƒƒãƒˆä»¥å¤–ã¯æŠ˜ã‚ŠãŸãŸã¿ï¼ˆã€Œå…¨éƒ¨é–‹ãã£ã±ãªã—ã€ã‚’é˜²ãï¼‰
      if(q && !hit){
        s.open = false;
        s.card.classList.add("collapsed");
      }
    });
  }else{
    items.forEach(name=>{
      const s = itemState.get(name);
      const hit = !q || s.normName.includes(q);
      s.card.style.display = hit ? "" : "none";

      if(q && !hit){
        s.open = false;
        s.card.classList.add("collapsed");
      }
    });
  }
}

qEl.addEventListener("input", applyFilter);
qClear.onclick = ()=>{
  qEl.value = "";
  applyFilter();
};

/* ======================
   Copy + delivery immediate reflect
====================== */
copyBtn.onclick = ()=>{
  const t = outEl.value.trim();
  if(!t) return;

  navigator.clipboard.writeText(t).then(()=>{
    const prev = copyBtn.textContent;
    copyBtn.textContent = "ã‚³ãƒ”ãƒ¼æ¸ˆã¿âœ“";
    copyBtn.disabled = true;
    setTimeout(()=>{
      copyBtn.textContent = prev;
      copyBtn.disabled = false;
    }, 1200);
  });
};

deliveryEl.value = store.delivery || "å³ç´å“å¯èƒ½";
deliveryEl.onchange = ()=>{
  saveStore();
  rebuildOutput(); // å¤‰æ›´æ™‚ã«å³åæ˜ 
};

/* ======================
   Collapsing rules (stable)
   - è‡ªå‹•æŠ˜ã‚ŠãŸãŸã¿ï¼šæ•°é‡0ã®ã‚«ãƒ¼ãƒ‰ï¼ˆæ¤œç´¢ä¸­ä»¥å¤–ï¼‰
   - æ‰‹å‹•ã§é–‹ã„ãŸã‚«ãƒ¼ãƒ‰ã¯ã€ã‚¿ã‚¤ãƒ—å¤‰æ›´ã§ã¯é–‰ã˜ãªã„
   - ã‚‚ã†ä¸€åº¦é–‰ã˜ãŸã„æ™‚ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¿ãƒƒãƒ—ã§é–‹é–‰
====================== */
function autoCollapseIfEmptyDino(s){
  const q = norm(qEl.value);
  const qty = (s.m||0) + (s.f||0);
  if(q) return; // æ¤œç´¢ä¸­ã¯ applyFilter å´ã§åˆ¶å¾¡
  if(qty === 0 && !s.open){
    s.card.classList.add("collapsed");
  }
}
function autoCollapseIfEmptyItem(s){
  const q = norm(qEl.value);
  if(q) return;
  if((s.qty||0) === 0 && !s.open){
    s.card.classList.add("collapsed");
  }
}

/* ======================
   Auto (æŒ‡å®š) logic for dinos
   - â™‚ã¨â™€ã®ä¸¡æ–¹ã«å…¥åŠ›ãŒã‚ã‚‹å ´åˆï¼šè‡ªå‹•ã§(æŒ‡å®š)ã¸
   - ä¸¡æ–¹0ã«ãªã£ãŸã‚‰ï¼šè‡ªå‹•(æŒ‡å®š)è§£é™¤ï¼ˆå…ƒã®ãƒ™ãƒ¼ã‚¹ã¸æˆ»ã™ï¼‰
   - è‡ªå‹•ã§å¤‰ãˆãŸå ´åˆã®ã¿è§£é™¤ã™ã‚‹ï¼ˆæ‰‹å‹•æŒ‡å®šã¯ç¶­æŒï¼‰
====================== */
function updateAutoSpecified(s){
  const both = (s.m>0 && s.f>0);

  // è§£é™¤æ¡ä»¶ï¼ˆä¸¡æ–¹0ï¼‰
  const allZero = (s.m===0 && s.f===0);

  const hasSpec = !!hasSpecified[s.type];
  const isSpecified = s.type.endsWith("(æŒ‡å®š)");
  const base = baseFromSpecified[s.type];

  if(both){
    // baseã‚¿ã‚¤ãƒ—ã«æŒ‡å®šãŒã‚ã‚‹ãªã‚‰æŒ‡å®šã¸
    if(hasSpecified[s.type]){
      s.type = hasSpecified[s.type];
      s.autoSpecified = true;
    }else if(!isSpecified && base && hasSpecified[base]){
      // ã™ã§ã«æŒ‡å®šã®å¯èƒ½æ€§ã¯å°‘ãªã„ãŒä¿é™º
      s.type = hasSpecified[base];
      s.autoSpecified = true;
    }else{
      // å—ç²¾åµ/èƒš/ã‚¯ãƒ­ãƒ¼ãƒ³ ä»¥å¤–ã¯ãã®ã¾ã¾ï¼ˆå¹¼ä½“/æˆä½“ã¯æŒ‡å®šæ¦‚å¿µãªã—ï¼‰
      // ä½•ã‚‚ã—ãªã„
    }
  }else if(allZero){
    // è‡ªå‹•ã§æŒ‡å®šã«ã—ãŸã‚‚ã®ã ã‘è§£é™¤
    if(s.autoSpecified && isSpecified && base){
      s.type = base;
      s.autoSpecified = false;
    }
  }
}

/* ======================
   Output builder (shared)
   - ä¸Šï¼šæç«œï¼ˆå…¥åŠ›ãŒã‚ã‚‹ã‚‚ã®ï¼‰
   - ä¸‹ï¼šã‚¢ã‚¤ãƒ†ãƒ ï¼ˆå…¥åŠ›ãŒã‚ã‚‹ã‚‚ã®ï¼‰
====================== */
function rebuildOutput(){
  let lines = [];
  let sum = 0;
  let idx = 1;

  // dinos
  for(const name of dinos){
    const s = dinoState.get(name);
    const qty = (s.m||0) + (s.f||0);
    if(qty === 0) continue;

    const price = (prices[s.type]||0) * qty;
    sum += price;

    const t = displayType(s.type);
    let line = "";

    // ãƒšã‚¢è¡¨è¨˜ï¼šâ™‚=â™€ ã®ã¨ã
    if(pairTypes.has(s.type) && s.m === s.f && s.m > 0){
      line = `${name}${t}ãƒšã‚¢${s.m>1 ? "Ã—"+s.m : ""} = ${yen(price)}`;
    }else if(pairTypes.has(s.type)){
      // â™‚ or â™€ ã‚’0ãªã‚‰å‡ºã•ãªã„
      const parts = [];
      if(s.m>0) parts.push(`â™‚Ã—${s.m}`);
      if(s.f>0) parts.push(`â™€Ã—${s.f}`);
      line = `${name}${t} ${parts.join(" ")} = ${yen(price)}`.replace(/\s+ =/," =");
    }else{
      line = `${name}${t}Ã—${qty} = ${yen(price)}`;
    }

    lines.push(`${idx}. ${line}`);
    idx++;
  }

  // items
  for(const name of items){
    const s = itemState.get(name);
    const q = s.qty||0;
    if(q === 0) continue;

    const totalCount = q * s.unitCount;
    const price = q * s.unitPrice;
    sum += price;

    // è¡¨è¨˜ä¾‹: TEKå¤©äº• Ã— 300 = 300å††
    const line = `${name} Ã— ${totalCount} = ${yen(price)}`;
    lines.push(`${idx}. ${line}`);
    idx++;
  }

  totalEl.textContent = yen(sum);

  outEl.value =
`ã“ã®åº¦ã¯ã”æ¤œè¨ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
ã”å¸Œæœ›å†…å®¹ã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ğŸ‘‡ğŸ»

${lines.join("\n")}
ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼
è¨ˆï¼š${yen(sum)}
æœ€çŸ­ç´å“ç›®å®‰ : ${deliveryEl.value}

ã”å¸Œæœ›å†…å®¹ã€é‡‘é¡ã‚’ã”ç¢ºèªã®ä¸Šè³¼å…¥ã®æ–¹ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ğŸ™ğŸ»

ã¾ãŸã€è¿½åŠ ã‚„å¤‰æ›´ãªã©ã‚ã‚Šã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠç”³ã—ä»˜ã‘ãã ã•ã„ğŸ‘ğŸ»`;
}

/* ======================
   Card builders
====================== */
function makeDinoCard(name, defType){
  const s = {
    name,
    defType,
    type: defType,
    m:0,
    f:0,
    open:false,
    autoSpecified:false,
    normName: norm(name),
    card:null
  };

  const card = document.createElement("div");
  s.card = card;
  card.className = "card collapsed";

  card.innerHTML = `
    <div class="cardHeader">
      <div class="name">${name}</div>
      <div class="right">
        <select class="type">
          ${Object.keys(prices).map(t=>`<option value="${t}">${t}</option>`).join("")}
        </select>
        <div class="unit">å˜ä¾¡${prices[defType]}å††</div>
      </div>
    </div>

    <div class="cardBody">
      <div class="stepRow">
        <div class="box m">
          <div class="stepper">
            <button class="btn" data-sex="m" data-d="-1">âˆ’</button>
            <div class="val mc">0</div>
            <button class="btn" data-sex="m" data-d="1">ï¼‹</button>
          </div>
        </div>
        <div class="box f">
          <div class="stepper">
            <button class="btn" data-sex="f" data-d="-1">âˆ’</button>
            <div class="val fc">0</div>
            <button class="btn" data-sex="f" data-d="1">ï¼‹</button>
          </div>
        </div>
      </div>
    </div>
  `;

  const header = card.querySelector(".cardHeader");
  const sel = card.querySelector("select.type");
  const unit = card.querySelector(".unit");
  const mc = card.querySelector(".mc");
  const fc = card.querySelector(".fc");

  // initial
  sel.value = s.type;
  unit.textContent = `å˜ä¾¡${prices[s.type]}å††`;

  // header toggle open/close
  header.onclick = (e)=>{
    // selectæ“ä½œã¯é™¤å¤–
    if(e.target && (e.target.tagName === "SELECT" || e.target.closest("select"))) return;
    s.open = !s.open;
    card.classList.toggle("collapsed", !s.open);
    // é–‹ã„ãŸã‚‰æ¤œç´¢çµæœä»¥å¤–ã¯æŠ˜ã‚Šç•³ã¾ãªã„ï¼ˆãŸã ã—æ¤œç´¢ä¸­ã¯applyFilterå´ï¼‰
  };

  // type change should NOT auto-close
  sel.onchange = ()=>{
    s.type = sel.value;
    unit.textContent = `å˜ä¾¡${prices[s.type]}å††`;

    // opençŠ¶æ…‹ã¯ç¶­æŒï¼ˆã“ã“ãŒæœ¬é¡Œï¼‰
    if(s.open){
      card.classList.remove("collapsed");
    }

    // å…¥åŠ›0ãªã‚‰è‡ªå‹•è§£é™¤åˆ¤å®šï¼ˆæŒ‡å®šï¼‰
    updateAutoSpecified(s);
    sel.value = s.type; // è‡ªå‹•æŒ‡å®šã§å¤‰ã‚ã£ãŸå ´åˆåæ˜ 
    unit.textContent = `å˜ä¾¡${prices[s.type]}å††`;

    rebuildOutput();
    saveStore();
  };

  // buttons
  card.querySelectorAll(".btn").forEach(b=>{
    b.onclick = ()=>{
      const sex = b.dataset.sex;
      const d = Number(b.dataset.d);
      s[sex] = Math.max(0, (s[sex]||0) + d);

      // è‡ªå‹•æŒ‡å®šãƒ­ã‚¸ãƒƒã‚¯
      updateAutoSpecified(s);

      // UIåæ˜ 
      sel.value = s.type;
      unit.textContent = `å˜ä¾¡${prices[s.type]}å††`;
      mc.textContent = s.m;
      fc.textContent = s.f;

      // qty==0ãªã‚‰ï¼ˆè‡ªå‹•ã§ç•³ã‚€ç”¨ã« open=false ã«æˆ»ã™ã®ã¯ã—ãªã„ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–‹ã„ãŸã‚‰é–‹ã„ãŸã¾ã¾ã€‚ï¼‰
      // ãŸã ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–‹ã„ã¦ãªã„å ´åˆã¯ç•³ã‚€
      if(!s.open){
        card.classList.add("collapsed");
      }

      rebuildOutput();
      saveStore();
      autoCollapseIfEmptyDino(s);
    };
  });

  dinoState.set(name, s);
  secDino.appendChild(card);

  // åˆæœŸã¯æ•°é‡0ãªã®ã§è‡ªå‹•ã§ç•³ã‚€ï¼ˆcollapsedï¼‰
  return s;
}

function makeItemCard(name, unitCount, unitPrice){
  const s = {
    name,
    unitCount,
    unitPrice,
    qty:0,
    open:false,
    normName: norm(name),
    card:null
  };

  const card = document.createElement("div");
  s.card = card;
  card.className = "card collapsed";

  card.innerHTML = `
    <div class="cardHeader">
      <div class="name">${name}</div>
      <div class="right">
        <div class="unit">å˜ä½${unitCount} / å˜ä¾¡${unitPrice}å††</div>
      </div>
    </div>

    <div class="cardBody">
      <div class="stepRow">
        <div class="box item">
          <div class="stepper">
            <button class="btn" data-d="-1">âˆ’</button>
            <div class="val vc">0</div>
            <button class="btn" data-d="1">ï¼‹</button>
          </div>
        </div>
      </div>
    </div>
  `;

  const header = card.querySelector(".cardHeader");
  const vc = card.querySelector(".vc");

  header.onclick = (e)=>{
    s.open = !s.open;
    card.classList.toggle("collapsed", !s.open);
  };

  card.querySelectorAll(".btn").forEach(b=>{
    b.onclick = ()=>{
      const d = Number(b.dataset.d);
      s.qty = Math.max(0, (s.qty||0) + d);
      vc.textContent = s.qty;

      if(!s.open){
        card.classList.add("collapsed");
      }

      rebuildOutput();
      saveStore();
      autoCollapseIfEmptyItem(s);
    };
  });

  itemState.set(name, s);
  secItem.appendChild(card);
  return s;
}

/* ======================
   Merge base + user changes
====================== */
function keyOfDino(rec){ return rec.name; }
function keyOfItem(rec){ return rec.name; }

function mergeDinos(base){
  const deleted = new Set(store.dinosDeleted || []);
  const added = store.dinosAdded || [];

  const map = new Map();
  for(const rec of base){
    if(deleted.has(rec.name)) continue;
    map.set(rec.name, rec);
  }
  for(const rec of added){
    if(!rec || !rec.name) continue;
    if(deleted.has(rec.name)) continue;
    const defType = (rec.defType && (rec.defType in prices)) ? rec.defType : "å—ç²¾åµ";
    map.set(rec.name, { name: rec.name, defType });
  }
  return Array.from(map.values());
}

function mergeItems(base){
  const deleted = new Set(store.itemsDeleted || []);
  const added = store.itemsAdded || [];

  const map = new Map();
  for(const rec of base){
    if(deleted.has(rec.name)) continue;
    map.set(rec.name, rec);
  }
  for(const rec of added){
    if(!rec || !rec.name) continue;
    if(deleted.has(rec.name)) continue;

    const unitCount = Number(rec.unitCount);
    const unitPrice = Number(rec.unitPrice);
    if(!Number.isFinite(unitCount) || unitCount<=0) continue;
    if(!Number.isFinite(unitPrice) || unitPrice<0) continue;

    map.set(rec.name, { name: rec.name, unitCount, unitPrice });
  }
  return Array.from(map.values());
}

/* ======================
   Modal helpers
====================== */
let modalMode = null; // "addDino" | "addItem" | "manage"
function showModal(mode){
  modalMode = mode;
  modalBack.classList.add("show");
}
function hideModal(){
  modalBack.classList.remove("show");
  modalBody.innerHTML = "";
  modalNote.textContent = "";
  modalMode = null;
}
modalCancel.onclick = hideModal;
modalBack.addEventListener("click", (e)=>{
  if(e.target === modalBack) hideModal();
});

/* ======================
   Add / Manage UI
====================== */
addBtn.onclick = ()=>{
  if(activeTab === "dino") openAddDino();
  else openAddItem();
};

manageBtn.onclick = ()=>{
  openManage();
};

function openAddDino(){
  modalTitle.textContent = "æç«œã‚’è¿½åŠ ";
  modalOk.textContent = "è¿½åŠ ";
  modalNote.textContent = "â€»è¿½åŠ ã¯ã“ã®ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚æ®‹ã‚Šã¾ã™ï¼‰";

  const html = `
    <div class="form">
      <div class="field">
        <label>åå‰</label>
        <input id="newName" placeholder="ä¾‹ï¼šã‚«ãƒ«ã‚«ãƒ­" />
      </div>
      <div class="field">
        <label>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</label>
        <select id="newType">
          ${Object.keys(prices).map(t=>`<option value="${t}">${t}</option>`).join("")}
        </select>
      </div>
    </div>
  `;
  modalBody.innerHTML = html;

  showModal("addDino");

  modalOk.onclick = ()=>{
    const name = (document.getElementById("newName").value || "").trim();
    const defType = document.getElementById("newType").value;

    if(!name) return;

    // è¿½åŠ æ¸ˆã¿ãªã‚‰ä¸Šæ›¸ãï¼ˆdefTypeï¼‰
    const existsBaseOrAdded = dinos.includes(name);

    // store: deleteè§£é™¤
    store.dinosDeleted = (store.dinosDeleted||[]).filter(n=>n!==name);

    // store add/update
    const added = store.dinosAdded || [];
    const idx = added.findIndex(r=>r && r.name===name);
    const rec = { name, defType };
    if(idx >= 0) added[idx] = rec;
    else added.push(rec);
    store.dinosAdded = added;

    saveStore();

    if(!existsBaseOrAdded){
      dinos.push(name);
      makeDinoCard(name, (defType in prices) ? defType : "å—ç²¾åµ");
      applyFilter();
    }else{
      // æ—¢å­˜ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã‘æ›´æ–°ï¼ˆç¾åœ¨ã®typeã¯ç¶­æŒï¼‰
      const s = dinoState.get(name);
      if(s){
        s.defType = (defType in prices) ? defType : "å—ç²¾åµ";
        if((s.m+s.f)===0){
          s.type = s.defType;
          s.autoSpecified = false;
          const sel = s.card.querySelector("select.type");
          const unit = s.card.querySelector(".unit");
          sel.value = s.type;
          unit.textContent = `å˜ä¾¡${prices[s.type]}å††`;
        }
      }
      applyFilter();
      rebuildOutput();
    }

    hideModal();
  };
}

function openAddItem(){
  modalTitle.textContent = "ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ";
  modalOk.textContent = "è¿½åŠ ";
  modalNote.textContent = "å½¢å¼ï¼šå€‹æ•°å˜ä½ï¼ˆä¾‹ï¼š100ï¼‰ / å€¤æ®µï¼ˆä¾‹ï¼š100ï¼‰";

  const html = `
    <div class="form">
      <div class="field">
        <label>å•†å“å</label>
        <input id="newItemName" placeholder="ä¾‹ï¼šTEKå¤©äº•" />
      </div>
      <div class="field">
        <label>å€‹æ•°å˜ä½</label>
        <input id="newUnitCount" inputmode="numeric" placeholder="ä¾‹ï¼š100" />
      </div>
      <div class="field">
        <label>å€¤æ®µ</label>
        <input id="newUnitPrice" inputmode="numeric" placeholder="ä¾‹ï¼š100" />
      </div>
    </div>
  `;
  modalBody.innerHTML = html;

  showModal("addItem");

  modalOk.onclick = ()=>{
    const name = (document.getElementById("newItemName").value || "").trim();
    const unitCount = Number((document.getElementById("newUnitCount").value || "").trim());
    const unitPrice = Number((document.getElementById("newUnitPrice").value || "").trim());

    if(!name) return;
    if(!Number.isFinite(unitCount) || unitCount<=0) return;
    if(!Number.isFinite(unitPrice) || unitPrice<0) return;

    const exists = items.includes(name);

    store.itemsDeleted = (store.itemsDeleted||[]).filter(n=>n!==name);

    const added = store.itemsAdded || [];
    const idx = added.findIndex(r=>r && r.name===name);
    const rec = { name, unitCount, unitPrice };
    if(idx >= 0) added[idx] = rec;
    else added.push(rec);
    store.itemsAdded = added;

    saveStore();

    if(!exists){
      items.push(name);
      makeItemCard(name, unitCount, unitPrice);
      applyFilter();
    }else{
      const s = itemState.get(name);
      if(s && s.qty===0){
        s.unitCount = unitCount;
        s.unitPrice = unitPrice;
        s.card.querySelector(".unit").textContent = `å˜ä½${unitCount} / å˜ä¾¡${unitPrice}å††`;
      }
      applyFilter();
      rebuildOutput();
    }

    hideModal();
  };
}

function openManage(){
  modalTitle.textContent = "ç®¡ç†";
  modalOk.textContent = "é–‰ã˜ã‚‹";
  modalNote.textContent = "å‰Šé™¤ã¯ã“ã®ç«¯æœ«ã§ã®è¡¨ç¤º/ä¿å­˜ã‹ã‚‰å¤–ã—ã¾ã™ï¼ˆå¾Œã§å†è¿½åŠ ã§ãã¾ã™ï¼‰";

  const list = activeTab==="dino" ? dinos : items;

  const rows = list.map(name=>{
    return `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(0,0,0,.18);">
        <div style="font-weight:900;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${name}</div>
        <button class="delOne danger" data-name="${name}" style="height:34px;padding:0 12px;border-radius:12px;">å‰Šé™¤</button>
      </div>
    `;
  }).join("");

  modalBody.innerHTML = `
    <div class="form" style="gap:10px;">
      ${rows || `<div class="smallNote">ä¸€è¦§ãŒã‚ã‚Šã¾ã›ã‚“</div>`}
    </div>
  `;

  modalBody.querySelectorAll(".delOne").forEach(btn=>{
    btn.onclick = ()=>{
      const name = btn.dataset.name;
      if(activeTab==="dino") deleteDino(name);
      else deleteItem(name);
      // å†æç”»ï¼šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚æ›´æ–°
      openManage();
    };
  });

  showModal("manage");

  modalOk.onclick = hideModal;
}

function deleteDino(name){
  // stateã‹ã‚‰å‰Šé™¤ï¼ˆç”»é¢ã‹ã‚‰æ¶ˆã™ï¼‰
  const s = dinoState.get(name);
  if(s && s.card) s.card.remove();
  dinoState.delete(name);

  // store: addedã‹ã‚‰ã‚‚æ¶ˆã—ã€deletedã¸
  store.dinosAdded = (store.dinosAdded||[]).filter(r=>r && r.name!==name);
  if(!(store.dinosDeleted||[]).includes(name)){
    store.dinosDeleted = [...(store.dinosDeleted||[]), name];
  }
  saveStore();

  // list ã‹ã‚‰ã‚‚æ¶ˆã™
  const i = dinos.indexOf(name);
  if(i>=0) dinos.splice(i,1);

  rebuildOutput();
  applyFilter();
}

function deleteItem(name){
  const s = itemState.get(name);
  if(s && s.card) s.card.remove();
  itemState.delete(name);

  store.itemsAdded = (store.itemsAdded||[]).filter(r=>r && r.name!==name);
  if(!(store.itemsDeleted||[]).includes(name)){
    store.itemsDeleted = [...(store.itemsDeleted||[]), name];
  }
  saveStore();

  const i = items.indexOf(name);
  if(i>=0) items.splice(i,1);

  rebuildOutput();
  applyFilter();
}

/* ======================
   Load base files + build
====================== */
async function loadAll(){
  // base fetch
  const [dinoText, itemText] = await Promise.all([
    fetch("dinos.txt?ts="+Date.now()).then(r=>r.ok ? r.text() : ""),
    fetch("items.txt?ts="+Date.now()).then(r=>r.ok ? r.text() : "")
  ]);

  const baseDinos = dinoText.split(/\r?\n/).map(parseDinoLine).filter(Boolean);
  const baseItems = itemText.split(/\r?\n/).map(parseItemLine).filter(Boolean);

  // merge with localStorage
  const mergedDinos = mergeDinos(baseDinos);
  const mergedItems = mergeItems(baseItems);

  // build dinos
  mergedDinos.forEach(({name, defType})=>{
    dinos.push(name);
    makeDinoCard(name, defType);
  });

  // build items
  mergedItems.forEach(({name, unitCount, unitPrice})=>{
    items.push(name);
    makeItemCard(name, unitCount, unitPrice);
  });

  // initial filter + output
  applyFilter();
  rebuildOutput();
}

loadAll();
</script>
</body>
</html>