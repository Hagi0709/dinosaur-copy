<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>æç«œãƒªã‚¹ãƒˆ</title>

<style>
:root{
  --bg:#0b0f14;
  --txt:rgba(255,255,255,.92);
  --mut:rgba(255,255,255,.60);
  --ok:#78ffb3;

  --card1:rgba(255,255,255,.10);
  --card2:rgba(255,255,255,.06);
  --stroke:rgba(255,255,255,.10);

  --male:#74d7ff;
  --female:#ff86c8;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
  background:var(--bg);
  color:var(--txt);
  padding-bottom:120px;
}
button,select,input{touch-action:manipulation}

/* ===== top ===== */
.top{
  position:sticky;
  top:0;
  z-index:10;
  background:rgba(11,15,20,.95);
  backdrop-filter:blur(14px);
  padding:10px;
  padding-top:calc(10px + env(safe-area-inset-top));
  border-bottom:1px solid rgba(255,255,255,.06);
}
.row{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}
.search{
  flex:1;
  display:flex;
  align-items:center;
  gap:8px;
  height:36px;
  padding:0 10px;
  border-radius:14px;
  background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.12);
  min-width:0;
}
.search input{
  flex:1;
  border:0;
  outline:0;
  background:transparent;
  color:var(--txt);
  font-size:14px;
  min-width:0;
}
.qClear{
  width:26px;height:26px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  font-size:18px;
  color:#fff;
  display:inline-block;
  line-height:1;
}
.delivery,.copy{
  height:36px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.08);
  color:#fff;
  padding:0 12px;
  font-size:13px;
}
.copy{font-weight:900}
.total{
  margin-left:auto;
  font-size:14px;
  color:var(--ok);
  font-weight:900;
  white-space:nowrap;
}
textarea{
  width:100%;
  margin-top:8px;
  height:120px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  color:#fff;
  padding:10px;
  font-size:12px;
  line-height:1.45;
}

/* ===== tabs ===== */
.tabs{
  display:flex;
  gap:8px;
  margin-top:10px;
}
.tab{
  flex:1;
  height:34px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:rgba(255,255,255,.75);
  font-weight:900;
  font-size:13px;
}
.tab.active{
  background:rgba(255,255,255,.12);
  color:#fff;
}

/* ===== list ===== */
.list{padding:12px}
.card{
  background:linear-gradient(180deg,var(--card1),var(--card2));
  border:1px solid var(--stroke);
  border-radius:16px;
  padding:12px;
  margin-bottom:10px;
}
.card.collapsed .body{display:none}

.head{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
}
.name{font-weight:900;font-size:18px}
.right{
  text-align:right;
  display:flex;
  flex-direction:column;
  gap:6px;
}
select.type{
  padding:6px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.14);
  color:#fff;
  font-size:12px;
}
.unit{font-size:12px;color:var(--mut)}

.body{margin-top:10px}

/* ===== steppers ===== */
.row2{display:flex; gap:10px}
.box{
  flex:1;
  padding:8px;
  border-radius:14px;
  border:2px solid rgba(255,255,255,.10);
}
.box.m{border-color:rgba(116,215,255,.45); background:rgba(116,215,255,.14)}
.box.f{border-color:rgba(255,134,200,.45); background:rgba(255,134,200,.14)}

.stepper{
  display:flex;
  align-items:center;
  gap:10px;
}
.btn{
  width:46px;
  height:32px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.10);
  color:#fff;
  font-size:18px;
  font-weight:900;
  line-height:1;
}
.val{
  flex:1;
  text-align:center;
  font-weight:900;
  font-size:16px;
  letter-spacing:.2px;
  color:rgba(255,255,255,.92);
}

/* ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆå˜ä¸€ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼ï¼‰ */
.itemBox{
  border-color:rgba(255,255,255,.16);
  background:rgba(255,255,255,.06);
}
</style>
</head>

<body>
  <div class="top">
    <div class="row">
      <div class="search">
        <input id="q" placeholder="æ¤œç´¢">
        <button id="qClear" class="qClear">Ã—</button>
      </div>

      <select id="delivery" class="delivery">
        <option value="å³ç´å“å¯èƒ½">å³ç´å“å¯èƒ½</option>
        <option value="æœ¬æ—¥å¤œ">æœ¬æ—¥å¤œ</option>
      </select>

      <button id="copy" class="copy">ã‚³ãƒ”ãƒ¼</button>
      <div id="total" class="total">0å††</div>
    </div>

    <textarea id="out" readonly></textarea>

    <div class="tabs">
      <button id="tabDino" class="tab active">æç«œ</button>
      <button id="tabItem" class="tab">ã‚¢ã‚¤ãƒ†ãƒ </button>
    </div>
  </div>

  <div class="list" id="listDino"></div>
  <div class="list" id="listItem" style="display:none"></div>

<script>
/* ========= PRICES (æç«œ) ========= */
const dinoPrices = {
  "å—ç²¾åµ":30, "å—ç²¾åµ(æŒ‡å®š)":50,
  "èƒš":50,   "èƒš(æŒ‡å®š)":100,
  "å¹¼ä½“":100,
  "æˆä½“":500,
  "ã‚¯ãƒ­ãƒ¼ãƒ³":500, "ã‚¯ãƒ­ãƒ¼ãƒ³(æŒ‡å®š)":300
};

const pairTypes = new Set([
  "å—ç²¾åµ","å—ç²¾åµ(æŒ‡å®š)",
  "èƒš","èƒš(æŒ‡å®š)",
  "å¹¼ä½“","æˆä½“",
  "ã‚¯ãƒ­ãƒ¼ãƒ³","ã‚¯ãƒ­ãƒ¼ãƒ³(æŒ‡å®š)"
]);

/* è‡ªå‹•ã§(æŒ‡å®š)ã«åˆ‡ã‚Šæ›¿ãˆã‚‹å¯¾è±¡ï¼ˆãƒ™ãƒ¼ã‚¹å´ï¼‰ */
const autoSpecifyBase = new Set(["å—ç²¾åµ","èƒš","ã‚¯ãƒ­ãƒ¼ãƒ³"]);
function toSpecified(type){
  if(type==="å—ç²¾åµ") return "å—ç²¾åµ(æŒ‡å®š)";
  if(type==="èƒš") return "èƒš(æŒ‡å®š)";
  if(type==="ã‚¯ãƒ­ãƒ¼ãƒ³") return "ã‚¯ãƒ­ãƒ¼ãƒ³(æŒ‡å®š)";
  return type;
}
function toBase(type){
  if(type==="å—ç²¾åµ(æŒ‡å®š)") return "å—ç²¾åµ";
  if(type==="èƒš(æŒ‡å®š)") return "èƒš";
  if(type==="ã‚¯ãƒ­ãƒ¼ãƒ³(æŒ‡å®š)") return "ã‚¯ãƒ­ãƒ¼ãƒ³";
  return type;
}
function stripSpecified(type){ return type.replace("(æŒ‡å®š)",""); }

/* ========= STATE ========= */
const dinoOrder = [];
const dinoState = new Map(); // name -> {type,m,f, card, sel, unitEl, mcEl, fcEl, manualOpen:boolean}

const itemOrder = [];
const itemState = new Map(); // name -> {unit, price, q, card, qEl, unitEl}

const listDino = document.getElementById("listDino");
const listItem = document.getElementById("listItem");

const outEl = document.getElementById("out");
const totalEl = document.getElementById("total");

const qEl = document.getElementById("q");
const qClear = document.getElementById("qClear");
const delivery = document.getElementById("delivery");
const copyBtn = document.getElementById("copy");

const tabDino = document.getElementById("tabDino");
const tabItem = document.getElementById("tabItem");

let activeTab = "dino"; // 'dino' | 'item'

function yen(n){ return n.toLocaleString("ja-JP")+"å††"; }

/* ========= PARSE ========= */
function parseDinoLine(line){
  line = (line||"").trim();
  if(!line) return null;
  if(line.startsWith("#")) return null;

  line = line.replace(/^ãƒ»/,"").trim();
  if(!line) return null;

  const parts = line.split("|").map(s=>s.trim());
  const name = parts[0] || "";
  const rawType = parts[1] || "";
  if(!name) return null;

  const defType = (rawType && (rawType in dinoPrices)) ? rawType : "å—ç²¾åµ";
  return {name, defType};
}

function parseItemLine(line){
  line = (line||"").trim();
  if(!line) return null;
  if(line.startsWith("#")) return null;

  const parts = line.split("|").map(s=>s.trim());
  if(parts.length < 3) return null;

  const name = parts[0];
  const unit = Number(parts[1]);
  const price = Number(parts[2]);
  if(!name || !Number.isFinite(unit) || !Number.isFinite(price)) return null;
  return {name, unit, price};
}

/* ========= OUTPUT ========= */
function rebuild(){
  let lines = [];
  let sum = 0;
  let idx = 1;

  // ---- æç«œï¼ˆä¸Šï¼‰ ----
  for(const name of dinoOrder){
    const s = dinoState.get(name);
    if(!s) continue;

    const qty = (s.m||0) + (s.f||0);
    // è‡ªå‹•æŠ˜ã‚ŠãŸãŸã¿ï¼šæœªå…¥åŠ›ãªã‚‰é–‰ã˜ã‚‹ï¼ˆãŸã ã—æ‰‹å‹•ã§é–‹ã„ã¦ã„ã‚‹æ™‚ã¯ç¶­æŒï¼‰
    if(qty===0 && !s.manualOpen){
      s.card.classList.add("collapsed");
    }

    if(qty===0) continue;

    const price = (dinoPrices[s.type]||0) * qty;
    sum += price;

    const t = stripSpecified(s.type);
    let line = "";

    if(pairTypes.has(s.type)){
      if(s.m === s.f){
        // ãƒšã‚¢è¡¨è¨˜
        line = `${name}${t}ãƒšã‚¢${s.m>1 ? "Ã—"+s.m : ""} = ${yen(price)}`;
      }else{
        // â™‚â™€è¡¨è¨˜ï¼ˆ0ã¯å‡ºã•ãªã„ï¼‰
        const p = [];
        if(s.m>0) p.push(`â™‚Ã—${s.m}`);
        if(s.f>0) p.push(`â™€Ã—${s.f}`);
        line = `${name}${t}${p.join("")} = ${yen(price)}`; // ç”Ÿç‰©åã®å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹ä¸è¦
      }
    }else{
      // æ€§åˆ¥ä¸è¦ï¼ˆåˆç®—ï¼‰
      line = `${name}${t}Ã—${qty} = ${yen(price)}`;
    }

    lines.push(`${idx}. ${line}`);
    idx++;
  }

  // ---- ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆä¸‹ï¼‰ ----
  for(const name of itemOrder){
    const it = itemState.get(name);
    if(!it) continue;

    if(it.q<=0) continue;

    const realQty = it.unit * it.q;
    const price = it.price * it.q;
    sum += price;

    lines.push(`${idx}. ${name}Ã—${realQty} = ${yen(price)}`);
    idx++;
  }

  totalEl.textContent = yen(sum);
  outEl.value =
`ã“ã®åº¦ã¯ã”æ¤œè¨ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
ã”å¸Œæœ›å†…å®¹ã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ğŸ‘‡ğŸ»

${lines.join("\n")}
ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼
è¨ˆï¼š${yen(sum)}
æœ€çŸ­ç´å“ç›®å®‰ : ${delivery.value}

ã”å¸Œæœ›å†…å®¹ã€é‡‘é¡ã‚’ã”ç¢ºèªã®ä¸Šè³¼å…¥ã®æ–¹ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ğŸ™ğŸ»

ã¾ãŸã€è¿½åŠ ã‚„å¤‰æ›´ãªã©ã‚ã‚Šã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠç”³ã—ä»˜ã‘ãã ã•ã„ğŸ‘ğŸ»`;
}

/* ========= SEARCH + TABS ========= */
function applySearch(){
  const q = (qEl.value||"").trim();
  if(activeTab === "dino"){
    for(const name of dinoOrder){
      const s = dinoState.get(name);
      if(!s) continue;
      s.card.style.display = (!q || name.includes(q)) ? "" : "none";
    }
  }else{
    for(const name of itemOrder){
      const it = itemState.get(name);
      if(!it) continue;
      it.card.style.display = (!q || name.includes(q)) ? "" : "none";
    }
  }
}

qEl.addEventListener("input", applySearch);
qClear.addEventListener("click", ()=>{
  qEl.value = "";
  applySearch();
});

function setTab(next){
  activeTab = next;
  tabDino.classList.toggle("active", next==="dino");
  tabItem.classList.toggle("active", next==="item");
  listDino.style.display = (next==="dino") ? "" : "none";
  listItem.style.display = (next==="item") ? "" : "none";
  applySearch();
}
tabDino.addEventListener("click", ()=>setTab("dino"));
tabItem.addEventListener("click", ()=>setTab("item"));

/* delivery ã¯å¤‰æ›´æ™‚ã«å³åæ˜  */
delivery.addEventListener("change", rebuild);

/* ========= COPY ========= */
copyBtn.addEventListener("click", ()=>{
  const text = outEl.value.trim();
  if(!text) return;

  navigator.clipboard.writeText(text).then(()=>{
    const prev = copyBtn.textContent;
    copyBtn.textContent = "ã‚³ãƒ”ãƒ¼æ¸ˆã¿âœ“";
    copyBtn.disabled = true;
    setTimeout(()=>{
      copyBtn.textContent = prev;
      copyBtn.disabled = false;
    }, 900);
  });
});

/* ========= CARD BUILD: DINO ========= */
function buildDinoCard(name, defType){
  const s = { type:defType, m:0, f:0, manualOpen:false };
  dinoState.set(name, s);

  const card = document.createElement("div");
  s.card = card;
  card.className = "card collapsed";
  card.innerHTML = `
    <div class="head">
      <div class="name">${name}</div>
      <div class="right">
        <select class="type">
          ${Object.keys(dinoPrices).map(t=>`<option value="${t}">${t}</option>`).join("")}
        </select>
        <div class="unit">å˜ä¾¡${dinoPrices[defType]}å††</div>
      </div>
    </div>

    <div class="body">
      <div class="row2">
        <div class="box m">
          <div class="stepper">
            <button class="btn" data-sex="m" data-d="-1">âˆ’</button>
            <div class="val mc">0</div>
            <button class="btn" data-sex="m" data-d="1">ï¼‹</button>
          </div>
        </div>
        <div class="box f">
          <div class="stepper">
            <button class="btn" data-sex="f" data-d="-1">âˆ’</button>
            <div class="val fc">0</div>
            <button class="btn" data-sex="f" data-d="1">ï¼‹</button>
          </div>
        </div>
      </div>
    </div>
  `;
  listDino.appendChild(card);

  const sel = card.querySelector(".type");
  const unitEl = card.querySelector(".unit");
  const mcEl = card.querySelector(".mc");
  const fcEl = card.querySelector(".fc");
  s.sel = sel; s.unitEl = unitEl; s.mcEl = mcEl; s.fcEl = fcEl;

  // ãƒ˜ãƒƒãƒ€ã‚¿ãƒƒãƒ—ã§æŠ˜ã‚ŠãŸãŸã¿åˆ‡æ›¿
  card.querySelector(".head").addEventListener("click", ()=>{
    const isCollapsed = card.classList.contains("collapsed");
    if(isCollapsed){
      card.classList.remove("collapsed");
      s.manualOpen = true;
    }else{
      card.classList.add("collapsed");
      s.manualOpen = false;
    }
  });

  // åˆæœŸå€¤
  sel.value = defType;
  unitEl.textContent = `å˜ä¾¡${dinoPrices[sel.value]}å††`;

  sel.addEventListener("change", ()=>{
    s.type = sel.value;
    unitEl.textContent = `å˜ä¾¡${dinoPrices[s.type]}å††`;

    // ã€Œé–‹ã„ãŸçŠ¶æ…‹ã§ type å¤‰ãˆã¦ã‚‚é–‰ã˜ãªã„ã€= å¤‰æ›´ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã¯æŠ˜ã‚ŠãŸãŸã¿æ“ä½œã—ãªã„
    // ãŸã ã—ã€Œã‚‚ã†ä¸€åº¦é–‰ã˜ãŸã„ã€ã¯ head ã‚¿ãƒƒãƒ—ã§å¯èƒ½ï¼ˆä¸Šã§å®Ÿè£…æ¸ˆï¼‰

    rebuild();
  });

  function maybeAutoSpecify(){
    // ä¸¡æ–¹ã«å…¥åŠ›ã•ã‚ŒãŸã‚‰è‡ªå‹•ã§(æŒ‡å®š)ã¸ï¼ˆå¯¾è±¡ã¯ãƒ™ãƒ¼ã‚¹ã®ã¿ï¼‰
    if(autoSpecifyBase.has(s.type) && s.m>0 && s.f>0){
      s.type = toSpecified(s.type);
      sel.value = s.type;
      unitEl.textContent = `å˜ä¾¡${dinoPrices[s.type]}å††`;
    }
    // ä¸¡æ–¹0ã«ãªã£ãŸã‚‰è‡ªå‹•ã§(æŒ‡å®š)è§£é™¤ï¼ˆå¯¾è±¡ã¯æŒ‡å®šã®ã¿ï¼‰
    if((s.type==="å—ç²¾åµ(æŒ‡å®š)" || s.type==="èƒš(æŒ‡å®š)" || s.type==="ã‚¯ãƒ­ãƒ¼ãƒ³(æŒ‡å®š)") && s.m===0 && s.f===0){
      s.type = toBase(s.type);
      sel.value = s.type;
      unitEl.textContent = `å˜ä¾¡${dinoPrices[s.type]}å††`;
    }
  }

  card.querySelectorAll(".btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      // æŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã¦ã‚‚æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã€æŠ¼ã•ã‚ŒãŸã‚‰é–‹ã
      if(card.classList.contains("collapsed")){
        card.classList.remove("collapsed");
        s.manualOpen = true;
      }

      const sex = btn.dataset.sex;
      const d = Number(btn.dataset.d);
      s[sex] = Math.max(0, (s[sex]||0) + d);

      mcEl.textContent = s.m;
      fcEl.textContent = s.f;

      maybeAutoSpecify();
      rebuild();
    });
  });
}

/* ========= CARD BUILD: ITEM ========= */
function buildItemCard(name, unit, price){
  const it = { unit, price, q:0 };
  itemState.set(name, it);

  const card = document.createElement("div");
  it.card = card;
  card.className = "card collapsed";
  card.innerHTML = `
    <div class="head">
      <div class="name">${name}</div>
      <div class="right">
        <div class="unit">å˜ä½${unit} / å˜ä¾¡${price}å††</div>
      </div>
    </div>

    <div class="body">
      <div class="box itemBox">
        <div class="stepper">
          <button class="btn" data-d="-1">âˆ’</button>
          <div class="val qv">0</div>
          <button class="btn" data-d="1">ï¼‹</button>
        </div>
      </div>
    </div>
  `;
  listItem.appendChild(card);

  const qv = card.querySelector(".qv");
  it.qEl = qv;

  // ãƒ˜ãƒƒãƒ€ã‚¿ãƒƒãƒ—ã§æŠ˜ã‚ŠãŸãŸã¿åˆ‡æ›¿
  card.querySelector(".head").addEventListener("click", ()=>{
    const isCollapsed = card.classList.contains("collapsed");
    if(isCollapsed) card.classList.remove("collapsed");
    else card.classList.add("collapsed");
  });

  card.querySelectorAll(".btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      if(card.classList.contains("collapsed")) card.classList.remove("collapsed");

      it.q = Math.max(0, it.q + Number(btn.dataset.d));
      qv.textContent = it.q;

      // æœªå…¥åŠ›ãªã‚‰è‡ªå‹•ã§ç•³ã‚€ï¼ˆæ¬¡å›ã® rebuild ã§ï¼‰
      rebuild();
      if(it.q===0) card.classList.add("collapsed");
    });
  });
}

/* ========= LOAD FILES ========= */
async function loadAll(){
  // dinos.txt
  const dinoText = await fetch("dinos.txt?ts="+Date.now()).then(r=>r.text());
  dinoText.split(/\r?\n/).map(parseDinoLine).filter(Boolean).forEach(({name, defType})=>{
    if(dinoState.has(name)) return;
    dinoOrder.push(name);
    buildDinoCard(name, defType);
  });

  // items.txt
  try{
    const itemText = await fetch("items.txt?ts="+Date.now()).then(r=>{
      if(!r.ok) throw new Error("items.txt not found");
      return r.text();
    });

    itemText.split(/\r?\n/).map(parseItemLine).filter(Boolean).forEach(({name, unit, price})=>{
      if(itemState.has(name)) return;
      itemOrder.push(name);
      buildItemCard(name, unit, price);
    });
  }catch(e){
    // items.txt ç„¡ãã¦ã‚‚æç«œã ã‘å‹•ãã‚ˆã†ã«ã™ã‚‹ï¼ˆè½ã¨ã•ãªã„ï¼‰
    console.warn(e);
  }

  rebuild();
  applySearch();
}

loadAll();
</script>
</body>
</html>